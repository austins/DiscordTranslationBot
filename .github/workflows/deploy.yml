name: Deploy

on:
    push:
        branches: [ master ]
        paths-ignore:
            - '.github/**'
            - 'README.md'
            - 'LICENSE'

concurrency:
    group: deploy
    cancel-in-progress: true

jobs:
    #analyze:
    #uses: ./.github/workflows/analyze.yml
    test:
        #needs: analyze
        uses: ./.github/workflows/test.yml
    deploy:
        needs: test
        runs-on: ubuntu-latest
        steps:
            -   name: Checkout
                uses: actions/checkout@v3
            -   name: Set up .NET Core SDK
                uses: actions/setup-dotnet@v3
                with:
                    dotnet-version: '7.0.x'
            -   name: Install dependencies
                run: dotnet restore
            -   name: Build
                run: dotnet build --configuration Release --no-restore
            -   name: Login to Docker registry
                uses: docker/login-action@v2
                with:
                    registry: ${{ secrets.DOCKER_REGISTRY }}
                    username: ${{ secrets.DOCKER_USERNAME }}
                    password: ${{ secrets.DOCKER_PASSWORD }}
            -   name: Build image
                run: dotnet publish DiscordTranslationBot --os linux --arch x64 -c Release -p:ContainerImageName=${{ secrets.DOCKER_REGISTRY }}/austins/discordtranslationbot -p:PublishProfile=DefaultContainer
            -   name: Push image
                run: docker push ${{ secrets.DOCKER_REGISTRY }}/austins/discordtranslationbot:latest
            -   name: Trigger deployment webhook
                uses: distributhor/workflow-webhook@v2
                env:
                    webhook_url: ${{ secrets.WEBHOOK_URL }}
                    webhook_secret: ${{ secrets.WEBHOOK_SECRET }}
                    webhook_type: "json"
                    silent: true
