name: Deploy

on:
    push:
        branches: [ master ]

concurrency:
    group: deploy
    cancel-in-progress: true

env:
    REGISTRY: ghcr.io
    IMAGE_NAME: ${{ github.repository }}

jobs:
    analyze:
        uses: ./.github/workflows/codeql.yml
    test:
        uses: ./.github/workflows/test.yml
    docker:
        needs: [ analyze, test ]
        runs-on: ubuntu-latest
        steps:
            -   name: Checkout
                uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4
            -   name: Set up Docker Buildx
                uses: docker/setup-buildx-action@4fd812986e6c8c2a69e18311145f9371337f27d4 # v3
            -   name: Login to Docker registry
                uses: docker/login-action@9780b0c442fbb1117ed29e0efdff1e18412f7567 # v3
                with:
                    registry: ${{ env.REGISTRY }}
                    username: ${{ github.actor }}
                    password: ${{ secrets.GITHUB_TOKEN }}
            -   name: Extract Docker metadata
                id: meta
                uses: docker/metadata-action@8e5442c4ef9f78752691e2d8f8d19755c6f78e81 # v5
                with:
                    images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
                    tags: type=raw,value=latest,enable={{is_default_branch}}
            -   name: Build and push
                uses: docker/build-push-action@1ca370b3a9802c92e886402e0dd88098a2533b12 # v6
                with:
                    context: ./
                    push: true
                    tags: ${{ steps.meta.outputs.tags }}
                    labels: ${{ steps.meta.outputs.labels }}
                    cache-from: type=gha
                    cache-to: type=gha,mode=max
                    github-token: ${{ secrets.GITHUB_TOKEN }}
    deploy:
        needs: docker
        runs-on: ubuntu-latest
        steps:
            -   name: Trigger deployment webhook
                uses: distributhor/workflow-webhook@f5a294e144d6ef44cfac4d3d5e20b613bcee0d4b # v3
                env:
                    webhook_url: ${{ secrets.WEBHOOK_URL }}
                    webhook_secret: ${{ secrets.WEBHOOK_SECRET }}
